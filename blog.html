<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Blog â€“ TradeStone</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900 font-sans pb-16">
  <div id="header"></div>
  <script type="module">
    import { loadHeader } from './loadHeader.js';
    loadHeader();
  </script>

  <main class="max-w-2xl mx-auto mt-12 p-4 bg-white rounded-xl shadow">
    <h2 class="text-2xl font-bold mb-4">Blog</h2>
    <div class="mb-4">
      <input id="search" type="text" class="w-full p-2 border rounded" placeholder="Search posts" />
    </div>
    <form id="post-form" class="space-y-2 mb-6 hidden">
      <input id="title" type="text" required placeholder="Title" class="w-full p-2 border rounded">
      <textarea id="content" required placeholder="Share something..." class="w-full p-2 border rounded"></textarea>
      <button type="submit" class="bg-orange-500 text-white px-4 py-2 rounded">Post</button>
    </form>
    <div id="posts-list" class="space-y-4"></div>
  </main>

  <script src="firebase-config.js"></script>
  <script type="module">
    import { initFirebase } from './firebase-init.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js';
    import { createPost, getPosts } from './blog.js';

    const { auth } = initFirebase();
    const form = document.getElementById('post-form');
    const list = document.getElementById('posts-list');
    const searchInput = document.getElementById('search');
    let allPosts = [];

    onAuthStateChanged(auth, user => {
      if (user) {
        form.classList.remove('hidden');
        form.addEventListener('submit', async e => {
          e.preventDefault();
          await createPost(user.uid, form.title.value, form.content.value);
          form.reset();
          loadPosts();
        });
      }
    });

    async function loadPosts() {
      list.innerHTML = '';
      allPosts = await getPosts();
      if (!allPosts.length) {
        list.innerHTML = '<p class="text-center">No posts yet.</p>';
        return;
      }
      filterAndRender();
    }

    function filterAndRender() {
      const search = searchInput.value.toLowerCase();
      const filtered = allPosts.filter(p =>
        p.title.toLowerCase().includes(search) ||
        p.content.toLowerCase().includes(search)
      );
      if (!filtered.length) {
        list.innerHTML = '<p class="text-center">No posts found.</p>';
        return;
      }
      for (const post of filtered) {
        const div = document.createElement('div');
        div.className = 'border-b pb-4';

        const h3 = document.createElement('h3');
        h3.className = 'text-xl font-bold';
        const link = document.createElement('a');
        link.href = `blog-post.html?id=${post.id}`;
        link.className = 'text-orange-500 hover:underline';
        link.textContent = post.title;
        h3.appendChild(link);

        const preview = document.createElement('p');
        preview.className = 'text-sm text-gray-700';
        const truncated = post.content.slice(0, 100) + (post.content.length > 100 ? '...' : '');
        preview.textContent = truncated;

        const hammerP = document.createElement('p');
        hammerP.className = 'text-xs text-gray-500';
        hammerP.textContent = `Hammers: ${post.hammerCount || 0}`;

        div.appendChild(h3);
        div.appendChild(preview);
        div.appendChild(hammerP);
        list.appendChild(div);
      }
    }

    searchInput.addEventListener('input', filterAndRender);
    loadPosts();
  </script>
  <div id="footer"></div>
  <script>
    fetch('footer.html')
      .then(res => res.text())
      .then(html => { document.getElementById('footer').innerHTML = html; });
  </script>
</body>
</html>
