<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Blog – TradeStone</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="text-gray-900 font-sans pb-16 bg-gray-100">
  <div id="header"></div>
  <script type="module">
    import { loadHeader } from './loadHeader.js';
    loadHeader();
  </script>

  <main class="max-w-3xl mx-auto p-4 space-y-4">
    <h2 class="text-2xl font-bold">Blog</h2>
    <div class="bg-white p-4 rounded shadow">
      <input id="search" type="text" class="w-full p-2 border rounded" placeholder="Search posts" />
    </div>
    <form id="post-form" class="space-y-2 bg-white p-4 rounded shadow hidden">
      <input id="title" type="text" required placeholder="Title" class="w-full p-2 border rounded">
      <textarea id="content" required placeholder="Share something..." class="w-full p-2 border rounded"></textarea>
      <button type="submit" class="bg-orange-500 text-white px-4 py-2 rounded">Post</button>
    </form>
    <div id="posts-list" class="space-y-4"></div>
  </main>

  <script type="module">
    import { createPost, getPosts, getPost, toggleHammer } from './blog.js';
    import { initSupabase } from './supabase-init.js';

    const form = document.getElementById('post-form');
    const list = document.getElementById('posts-list');
    const searchInput = document.getElementById('search');
    let allPosts = [];
    let currentUser = null;

    const supabase = initSupabase();
    const { data: { session } } = await supabase.auth.getSession();
    if (session?.user) {
      const { data, error } = await supabase
        .from('users')
        .select('account_type')
        .eq('id', session.user.id)
        .single();
      if (!error) {
        currentUser = { id: session.user.id, email: session.user.email, accountType: data.account_type };
        form.classList.remove('hidden');
      }
    }

    const ACCOUNT_SYMBOLS = { professional: '🛠️', personal: '👤' };

    function getGuestId() {
      let id = localStorage.getItem('guest-id');
      if (!id) {
        id = 'guest-' + Date.now();
        localStorage.setItem('guest-id', id);
      }
      return id;
    }

    form.addEventListener('submit', async e => {
      e.preventDefault();
      if (!currentUser) return;
      await createPost(currentUser, form.title.value, form.content.value);
      form.reset();
      loadPosts();
    });

    async function loadPosts() {
      list.innerHTML = '';
      allPosts = await getPosts();
      if (!allPosts.length) {
        list.innerHTML = '<p class="text-center">No posts yet.</p>';
        return;
      }
      filterAndRender();
    }

    function filterAndRender() {
      const search = searchInput.value.toLowerCase();
      const filtered = allPosts.filter(p =>
        p.title.toLowerCase().includes(search) ||
        p.content.toLowerCase().includes(search)
      );
      if (!filtered.length) {
        list.innerHTML = '<p class="text-center">No posts found.</p>';
        return;
      }
      const hammerUserId = currentUser ? currentUser.id : getGuestId();
      for (const post of filtered) {
        const div = document.createElement('div');
        div.className = 'flex bg-white p-4 rounded shadow';

        const vote = document.createElement('div');
        vote.className = 'flex flex-col items-center mr-4 text-gray-500';

        const upBtn = document.createElement('button');
        upBtn.innerHTML = '▲';
        upBtn.className = 'hover:text-orange-500';
        const count = document.createElement('span');
        count.className = 'text-sm';
        count.textContent = post.hammerCount || 0;
        if (post.hammeredBy?.includes(hammerUserId)) {
          upBtn.disabled = true;
          upBtn.classList.add('text-orange-500');
        }
        upBtn.addEventListener('click', async () => {
          const changed = await toggleHammer(post.id, hammerUserId);
          if (changed) {
            const updated = await getPost(post.id);
            count.textContent = updated.hammerCount || 0;
            upBtn.disabled = true;
            upBtn.classList.add('text-orange-500');
          }
        });

        vote.appendChild(upBtn);
        vote.appendChild(count);

        const content = document.createElement('div');
        content.className = 'flex-1';

        const h3 = document.createElement('h3');
        h3.className = 'text-lg font-semibold';
        const link = document.createElement('a');
        link.href = `blog-post.html?id=${post.id}`;
        link.className = 'text-orange-500 hover:underline';
        link.textContent = post.title;
        h3.appendChild(link);

        const preview = document.createElement('p');
        preview.className = 'text-sm text-gray-700';
        const truncated = post.content.slice(0, 100) + (post.content.length > 100 ? '...' : '');
        preview.textContent = truncated;

        const meta = document.createElement('div');
        meta.className = 'text-xs text-gray-500 mt-2';
        const symbol = ACCOUNT_SYMBOLS[post.accountType] || '';
        const proTag = post.accountType === 'professional' ? 'Pro' : '';
        meta.textContent = `${symbol} ${post.author} ${proTag ? '(' + proTag + ')' : ''} · ${post.comments.length} comments`;

        content.appendChild(h3);
        content.appendChild(preview);
        content.appendChild(meta);

        div.appendChild(vote);
        div.appendChild(content);
        list.appendChild(div);
      }
    }

    searchInput.addEventListener('input', filterAndRender);
    loadPosts();
  </script>
  <div id="footer"></div>
  <script>
    fetch('footer.html')
      .then(res => res.text())
      .then(html => { document.getElementById('footer').innerHTML = html; });
  </script>
</body>
</html>
